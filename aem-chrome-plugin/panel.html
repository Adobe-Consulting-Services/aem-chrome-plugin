<!--
  ~ #%L
  ~ AEM Chrome Plug-in
  ~ %%
  ~ Copyright (C) 2016 Adobe
  ~ %%
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~      http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  ~ #L%
  -->

<html ng-app="aem-chrome-plugin-app">
  <head>
    <link rel="stylesheet" type="text/css" href="assets/stylesheets/panel.css">

    <script src="vendor/assets/javascripts/jquery-2.2.0.min.js"></script>
    <script src="vendor/assets/javascripts/jquery-ui-1.9.2.tabs.min.js"></script>
    <script src="vendor/assets/javascripts/stupidtable.min.js"></script>
    <script src="vendor/assets/javascripts/URI.min.js"></script>
    <script src="vendor/assets/javascripts/angular.min.js"></script>

    <script src="assets/javascripts/devtools/app.js"></script>

    <script src="assets/javascripts/devtools/filters/remove-host-filter.js"></script>
    <script src="assets/javascripts/devtools/filters/log-blacklist-filter.js"></script>
    <script src="assets/javascripts/devtools/filters/query-blacklist-filter.js"></script>

    <script src="assets/javascripts/devtools/directives/dividers-directive.js"></script>
    <script src="assets/javascripts/devtools/directives/log-list-directive.js"></script>

    <script src="assets/javascripts/devtools/services/requests-service.js"></script>
    <script src="assets/javascripts/devtools/services/communications-service.js"></script>
    <script src="assets/javascripts/devtools/services/tracer-status-service.js"></script>

    <script src="assets/javascripts/devtools/controllers/requests-controller.js"></script>
    <script src="assets/javascripts/devtools/controllers/options-controller.js"></script>

  </head>
  <body class="aem-chrome-plugin" aem-chrome-plugin-panels>
    <div class="aem-chrome-plugin-requests-controller split-view"
         ng-controller="RequestsCtrl"
         ng-init="init();">

      <div  ng-show="!osgi.valid"
            class="hide-onload error-overlay">
        <div class="error-message">
            <h1>Attention!</h1>

            <p>A valid Apache Sling Log Tracer cannot be found on the AEM instance.</p>

            <p>Please review and correct any settings in the AEM Chrome Plug-in options.</p>

            <ul style="margin-left: .5rem;">
              <li><strong>Chrome > Window > Extensions > AEM Chrome Plug-in > Options</strong></li>
            </ul>
        </div>
      </div>

      <div class="split-view-contents split-view-contents-requests">

        <div class="data-grid data-grid-requests">
          <div class="control-bar">
              <span class="control-url-filter">
                <input class="control-filter" type="text"
                       placeholder="URL Filter"
                       ng-model="controls.urlFilter"/>
              </span>
              <span class="control-search-filter">
                <input class="control-filter" type="text"
                       placeholder="Search"
                       ng-model="controls.searchFilter"/>
              </span>
              <span class="control-max-requests">
                {{ requestKeys.length }} / <input type="number"
                       min="0"
                       ng-model="controls.maxRequests"/>
              </span>
              <span class="control-clear">
                <input type="button" value="Clear" ng-click="clear()"/>
              </span>
              <span class="control-reload">
                <input type="button" value="Reload" ng-click="reload()"/>
              </span>
          </div>
          <table class="header">
            <tr>
              <th class="status">Status</th>
              <th class="url">URL</th>
              <th class="method">Method</th>
              <th class="duration">Resp. Time</th>
            </tr>
          </table>
          <div class="data-container">
            <table id="requests">
              <tr ng-repeat="request in requests() | filter: {request: {url: controls.searchFilter}} track by $index "
                  ng-click="setActive(request.key)"
                  ng-class="getClass(request.key)">

                <td class="status">{{ request.response.status }}</td>
                <td class="url ellipsis">{{ request.request.url | removeHost }}</td>
                <td class="method">{{ request.request.method }}</td>
                <td class="duration">{{ request.time | number: 0 }}ms</td>
              </tr>
              <tr class="filler">
                <td class="status"></td>
                <td class="url"></td>
                <td class="method"></td>
                <td class="duration"></td>
              </tr>
            </table>
          </div>
        </div>
      </div>
      <div class="split-view-contents split-view-contents-details">
        <div id="vdivider"></div>
        <div id="tabs" class="tabbed-pane">
          <div id="hdivider"></div>
          <div class="request-info">
            <button
              class="mini-options--button"
              ng-click="showMiniOptions = !showMiniOptions">...</button>

            <span ng-hide="activeRequest">
              Select a request to see the details
            </span>
            <span ng-show="activeRequest">
              {{ activeRequest.request.method }} {{ activeRequest.request.url | removeHost }}
            </span>

<!-- Mini Options -->
<div id="mini-options" ng-show="showMiniOptions">

  <button class="mini-options--close"
        ng-click="showMiniOptions = !showMiniOptions">X</button>

  <div ng-controller="OptionsCtrl">
  <!--

  <div class="field-wrapper">
    <label class="text">AEM Host</label>
    <input type="text" ng-model="options.host"/>
  </div>

  <div class="field-wrapper">
    <label class="text">Web Console User</label>
    <input type="text" ng-model="options.user"/>
  </div>

  <div class="field-wrapper">
    <label class="text">Web Console Password</label>
    <input type="text" ng-model="options.password"/>
  </div>

  -->

  <div class="field-wrapper">
    <label class="text">Server Sling Tracer Ids</label>
    <input type="text" ng-model="options.tracerIds"/>
  </div>

  <div class="field-wrapper">
    <label class="text">Ad-hoc Tracer Sets</label>

    <div class="tracer-set"
      ng-repeat="set in options.tracerSets">
      <span class="tracer-set--enabled--wrapper">
      <input class="tracer-set--enabled"
           type="checkbox" ng-model="set.enabled" ng-true-value="true" ng-true-false="false"/>
      </span>
      <input class="tracer-set--package" type="text" ng-model="set.package" placeholder="Package"/>
      <select class="tracer-set--level" ng-model="set.level">
         <option value="TRACE">TRACE</option>
         <option value="DEBUG">DEBUG</option>
         <option value="INFO">INFO</option>
         <option value="WARN">WARN</option>
         <option value="ERROR">ERROR</option>
      </select>
      <button
       class="tracer-set--remove"
       ng-show="options.tracerSets.length > 1"
       ng-click="options.tracerSets.splice($index, 1)">Remove</button>
      </div>

      <button
       class="tracer-set--add"
       ng-click="options.tracerSets.push({enabled: true, package:'', level:'DEBUG'})">Add TracerSet</button>

    </div>
  </div>
</div>

<!-- End Options -->

          </div>
          <div class="tabbed-pane-header">
            <div class="tabbed-pane-header-contents">
              <ul class="tabbed-pane-header-tabs">
                <!-- Log Tab -->
                <li class="tabbed-pane-header-tab">
                  <a href="#tab-log" class="tabbed-pane-header-tab-title">Log
                    <span ng-show="activeTracerData.logs">({{ activeTracerData.logs.length }})</span></a>
                </li>
                <!-- Request Progress -->
                <li class="tabbed-pane-header-tab">
                  <a href="#tab-request-progress" class="tabbed-pane-header-tab-title">Request Progress
                    <span ng-show="activeTracerData.requestProgressLogs">({{ activeTracerData.requestProgressLogs.length }})</span></a>
                </li>
                <!-- Queries Tab -->
                <li class="tabbed-pane-header-tab">
                  <a href="#tab-queries" class="tabbed-pane-header-tab-title">Queries
                    <span ng-show="activeTracerData.queries">({{ activeTracerData.queries.length }})</span></a>
                </li>
                <!-- Timing
                <li class="tabbed-pane-header-tab">
                  <a href="#tab-timing" class="tabbed-pane-header-tab-title">Timing
                    <span ng-show="activeTracerData.time > 0">({{ activeTracerData.time || 0 }}ms)</a></span>
                </li>
                -->
              </ul>
            </div>
          </div>

          <div class="tabbed-pane-content data-grid data-grid-details">

            <!-- Log Tab Panel -->
            <div id="tab-log">
              <div class="tab-filter-container">
                <div class="tab-filter-wrapper">
                  <input class="tab-filter"
                         type="text"
                         placeholder="Filter Logs"
                         ng-model="controls.logFilter"
                         ng-model-options="{ debounce: { 'default': 500, 'blur': 0 } }"/>
                </div>

                <div aem-chrome-plugin-log-list
                     id="log"
                     class="tracer-log-list"
                     format="logs"
                     entries="activeTracerData.logs"
                     filter="controls.logFilter"
                     ng-show="notEmpty(activeTracerData.logs)">
                </div>

              </div>
            </div>

            <!-- Request Progress Tab Panel -->
            <div id="tab-request-progress">
              <div class="tab-filter-container">
                <div class="tab-filter-wrapper">
                    <input class="tab-filter"
                           type="text"
                           placeholder="Filter Request Progress"
                           ng-model="controls.requestProgressFilter"
                           ng-model-options="{ debounce: { 'default': 500, 'blur': 0 } }"/>
                </div>

                <div aem-chrome-plugin-log-list
                     id="request-progress"
                     format="requestProgress"
                     class="tracer-log-list"
                     entries="activeTracerData.requestProgressLogs"
                     filter="controls.requestProgressFilter"
                     ng-show="notEmpty(activeTracerData.requestProgressLogs)">
                </div>

              </div>
            </div>

            <!-- Queries Tab Panel -->
            <div id="tab-queries">
              <div class="tab-filter-container">
                <div class="tab-filter-wrapper">
                  <input class="tab-filter"
                         type="text"
                         placeholder="Filter Queries"
                         ng-model="controls.queryFilter"
                         ng-model-options="{ debounce: { 'default': 500, 'blur': 0 } }"/>
                </div>

                <div aem-chrome-plugin-log-list
                     id="queries"
                     class="tracer-log-list"
                     format="queries"
                     entries="activeTracerData.queries"
                     filter="controls.queryFilter"
                     ng-show="notEmpty(activeTracerData.queries)">
                </div>
              </div>
            </div>

            <!-- Timing Tab Panel
            <div id="tab-timing">
              <table id="timing">
                <tr>
                  <td>
                    <ul class="params-list">
                      <li>Server time: {{ (activeTracerData.time || 0) | number: 0 }}ms</li>
                      <li>Network time: {{ activeRequest.time - (activeTracerData.time || 0) | number: 0 }}ms</li>
                      <li>Total time: {{ activeRequest.time | number: 0 }}ms</li>
                    </ul>
                    </td>
                </tr>
              </table>
            </div>
            -->
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
